@{
    ViewBag.Title = "程控网";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@{Html.RenderAction("_PartialSearchHeader", "Common", new { tab = 0 });}
<div id="appSearch">
    <div class="nav_top">
        <div class="header_content">
            <div class="inputBox_wrap f-left ml30">
                <div class="inputBox overflow-hide ">
                    <input class="searchInput f-left" type="text" placeholder="课程/关键词" maxlength="20" v-model="input" @@keyup.enter.prevent="searchEnterFun($event)" />
                    <button class="searchButton btnColor f-left" @@click="search">
                        <span><img src="/Content/images/search_icon.png">搜索</span>
                    </button>
                </div>
                <div class="tagBox t-left mt10">
                    <template v-for="(item, index) in hots">
                        <a :key="index" href="javascript:void(0);" @@click="doSearchFun(item)">{{item}}</a>
                    </template>
                </div>
            </div>
        </div>
    </div>
    <div class="container overflow-hide">
        <div class="nav-left f-left">
            <ul class="nav_warp overflow-hide">
                <li :class="[ pager.tab == 0 ? 'f-left active' : 'f-left' ]" v-on:click="doActiveTab(0)">
                    课程
                    <i></i>
                </li>
                <li :class="[ pager.tab == 1 ? 'f-left ml50 active' : 'f-left ml50' ]" v-on:click="doActiveTab(1)">
                    文章
                    <i></i>
                </li>
            </ul>
            <div class="loading_lesson_data" style="display: block;">
                <div class="search_data">
                    <div class="search_data_part active lesson_data">
                        <div v-for="(item, index) in pager.list" :key="index" class="lesson_text overflow-hide">
                            <div class="lesson_text_left f-left overflow-hide">
                                <a :href="item.url" target="_blank">
                                    <img :src="item.image" />
                                </a>
                            </div>
                            <div class="lesson_text_right f-right">
                                <p class="p1 textControl">
                                    <a :href="item.url" target="_blank" class="textControl">{{ item.title }}</a>
                                </p>
                                <p class="p2">
                                    <a href="javascript:void(0);" class="a1">{{ item.source }}</a>
                                    <a href="javascript:void(0);" class="a2">
                                        <img src="/Content/images/icon_2.png">{{ item.visitors }}
                                    </a>
                                </p><p class="p3">
                                    <a :href="item.url" target="_blank" class="textControls">
                                        {{ item.description }}
                                    </a>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-if="pager.total > 0" class="pager">
                    <el-pagination background
                                   :page-size="pager.size"
                                   :current-page.sync="pager.page"
                                   @@current-change="handleCurrentChange"
                                   layout="prev, pager, next"
                                   :total="pager.total">
                    </el-pagination>
                </div>
            </div>
        </div>
        <div class="right-part f-right">
            <div class="search_histroy">
                <h5 class="overflow-hide">
                    <a href="javascript:void(0);" class="f-left size20 bold">搜索历史</a>
                    @*<a href="javascript:void(0);" class="f-right mt10">全部清除</a>*@
                </h5>
                <div class="history_list">
                    <template v-for="(item, index) in historyList">
                        <p :key="index" class="overflow-hide">
                            <a href="javascript:void(0);" class="f-left textControl"  @@click="doSearchFun(item.content)">{{item.content}}</a>
                            <span class="f-right">{{item.lasttime}}</span>
                        </p>
                    </template>
                </div>
            </div>
            <div class="hot_article overflow-hide mt30">
                <div class="title">
                    <a href="javascript:void(0);" class="hot_course size20 bold">热门文章</a>
                </div>
                <ul class="hot_article_list">
                    <template v-for="(item, index) in news">
                        <li :key="index" class="overflow-hide">
                            <span :class="[ index < 3 ? 'hot_style f-left' : 'f-left' ]">{{index + 1}}</span>
                            <a :href="'/Article/Content/'+item.id" target="_blank" class="textControl f-left">{{item.title}}</a>
                        </li>
                    </template>
                </ul>
            </div>
        </div>
    </div>
</div>
@{Html.RenderAction("_PartialFooter", "Common");}
<style type="text/css">

    .search_data {
        min-height: 400px;
    }

    .lesson_text {
        border-bottom: 1px solid#eeefff;
        padding: 30px 0px;
    }

    .lesson_text_left {
        width: 175px;
        height: 106px;
        border-radius: 6px;
    }

        .lesson_text_left img {
            width: 100%;
            height: 100%;
            transition: all .2s;
        }

            .lesson_text_left img:hover {
                transform: scale(1.1);
            }


    .lesson_text_right {
        width: 560px;
        height: 106px;
    }

        .lesson_text_right .p1 a {
            display: block;
            height: 20px;
            line-height: 20px;
            font-size: 16px;
            font-weight: 700;
            text-align: left;
            color: #333444;
        }

        .lesson_text_right .p2 {
            height: 20px;
            margin-top: 5px;
        }

            .lesson_text_right .p2 a {
                display: inline-block;
                float: left;
                font-size: 12px;
                color: #999aaa;
                margin-right: 10px;
            }

            .lesson_text_right .p2 .a1 {
                margin-right: 15px;
            }

            .lesson_text_right .p2 .a2 img {
                width: 12px;
                height: 10px;
                margin-right: 4px;
            }

        .lesson_text_right .p3 {
            height: 40px;
            margin-top: 7px;
        }

            .lesson_text_right .p3 a {
                font-size: 14px;
                color: #777888;
            }




    .textControls {
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }


    .nav_warp {
        border-bottom: 1px solid #e4e7ed;
    }

        .nav_warp li {
            width: 36px;
            height: 40px;
            font-size: 16px;
            font-weight: 400;
            text-align: center;
            color: #000000;
            position: relative;
            cursor: pointer;
            z-index: 2000;
        }

        .nav_warp .active {
            font-weight: 700;
            text-align: center;
            color: #1a8cfe;
        }

        .nav_warp li i {
            width: 36px;
            height: 4px;
            background: #1a8cfe;
            border-radius: 2px;
            position: absolute;
            bottom: 0px;
            left: 0px;
            display: none;
        }

        .nav_warp .active i {
            display: block;
        }

    .ml50 {
        margin-left: 50px;
    }


    .nav_top {
        width: 100%;
        height: 70px;
        line-height: 70px;
        background: rgba(255, 255, 255, 1);
        box-shadow: 0px 6px 12px rgb(99 110 155 / 10%);
        z-index: 2050;
    }

    .nav_top {
        width: 100%;
        height: 107px;
        z-index: 2050;
        padding-top: 26px;
        line-height: normal;
        box-shadow: none;
    }

    .header_content {
        margin: 0 auto;
        width: 1200px;
        height: 100%;
        text-align: center;
    }

    .nav_top .logo {
        vertical-align: middle;
    }

    .inputBox .searchInput {
        width: 525px;
        height: 38px;
        padding-left: 20px;
        font-size: 14px;
        font-weight: 400;
        line-height: 40px;
        color: #515151;
        background: rgba(255, 255, 255, 1);
        border: 1px solid rgba(238, 238, 238, 1);
        border-radius: 6px 0px 0px 6px;
        outline: none;
        background: #f9f9f9;
        border: 1px solid #eeeeee;
    }

    .inputBox .searchButton {
        width: 108px;
        height: 40px;
        line-height: 40px;
        font-weight: 400;
        color: rgba(255, 255, 255, 1);
        background: rgba(26, 140, 254, 1);
        border-radius: 0px 6px 6px 0px;
        outline: none;
        border: none;
        cursor: pointer;
    }

    .searchButton span {
        font-size: 14px;
        color: #fff;
    }

        .searchButton span img {
            width: 14px;
            position: relative;
            top: 0px;
            margin-right: 12px;
        }

    .t-left {
        text-align: left;
    }

    .tagBox a {
        display: inline-block;
        margin-right: 20px;
        font-size: 14px;
        font-weight: 400;
        color: rgba(144, 147, 153, 1);
        transition: color 0.2s;
    }


    .container {
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
    }

    .nav-left {
        width: 750px;
        min-height: 300px;
    }



    .right-part {
        width: 320px;
        min-height: 300px;
    }

    .f-right {
        float: right;
    }

    .history_list {
        min-height: 60px;
    }

    .search_histroy h5 {
        height: 42px;
        border-bottom: 1px solid#e4e7ed;
    }

    .history_list p {
        padding: 10px 0px;
    }

        .history_list p a:first-of-type {
            width: 160px;
            display: inline-block;
        }

        .history_list p a {
            font-size: 14px;
            color: #303133;
            font-weight: 400;
        }

        .history_list p span {
            font-size: 14px;
            color: #c0c4cc;
            height: 20px;
        }

    .overflow-hide {
        overflow: hidden !important;
    }

    .mt10 {
        margin-top: 10px;
    }

    .mt30 {
        margin-top: 30px;
    }

    .hot_article .title {
        width: 300px;
        border-bottom: 1px solid #e4e7ed;
    }

    .hot_course, .right-part {
        display: inline-block;
        padding: 14px 0px;
        color: #303133;
    }

    .size20 {
        font-size: 20px;
    }

    .bold {
        font-weight: 700;
    }

    .hot_article_list {
        min-height: 180px;
    }

        .hot_article_list li {
            height: 40px;
        }

            .hot_article_list li span {
                display: inline-block;
                width: 20px;
                height: 20px;
                line-height: 20px;
                text-align: center;
                background: #dcdfe6;
                border-radius: 3px;
                font-size: 14px;
                color: #fff;
                margin-top: 10px;
            }

        .hot_article_list .hot_style {
            background: #1a8cfe;
        }

    .f-left {
        float: left;
    }

    .hot_article_list li a {
        display: inline-block;
        margin-left: 13px;
        width: 280px;
        height: 20px;
        line-height: 20px;
        margin-top: 10px;
        font-size: 14px;
    }

    .textControl {
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
    }
</style>
<script>
    new Vue({
        el: "#appSearch",
        data() {
            return {
                hots: [],
                news: [],
                input: '',
                pager: {
                    tab: 0, //0：课程 1：文章
                    page: 1,
                    size: 10,
                    total: 0,
                    islast: false,
                    list: []
                },
                historyList:[]
            }
        },
        created() {
            const that = this
            that.input = '@ViewBag.KeyWords'
            var getLocalData = localStorage.getItem('history');
            var jsonData = JSON.parse(getLocalData);
            if (jsonData != null) {
                that.historyList = jsonData
            }
            else {
                that.historyList = []
            }
        },
        mounted() {
            const that = this
            that.loadHotData()
            that.loadArticleData()
            that.loadData()

            // 存储json字符串数据到本地
            //var jsonData = [{
            //    'content': '张三',
            //    'lasttime': '2021-10-22'
            //}, {
            //    'content': '电工',
            //    'lasttime': '2021-10-22'
            //}];
            //var str_jsonData = JSON.stringify(jsonData);
            //console.log(typeof (str_jsonData)); // string
            //console.log(str_jsonData);
            //localStorage.setItem('history', str_jsonData);

            // 读取json字符串数据
            //var getLocalData = localStorage.getItem('history');
            //console.log(typeof (getLocalData));
            //console.log(getLocalData);
            //var jsonObj = JSON.parse(getLocalData);
            //console.log(typeof (jsonObj));
            //console.log(jsonObj);
            //console.log(jsonObj[0].content);
        },
        methods: {
            searchEnterFun: function (e) {
                const that = this
                var keyCode = window.event ? e.keyCode : e.which;
                //console.log("回车搜索", keyCode, e);
                if (keyCode == 13) {
                    this.search()
                }
            },
            doSearchFun: function (val) {
                const that = this
                that.input = val
                this.search()
            },
            search: function () {
                const that = this
                if (that.input.length > 0) {
                    let date = new Date()
                    var getLocalData = localStorage.getItem('history');
                    var jsonData = JSON.parse(getLocalData);
                    if (jsonData != null) {
                        var currArr = jsonData.filter(function (item, index) {
                            return item.content == that.input
                        })
                        if (currArr.length == 0) {
                            jsonData.unshift({
                                'content': that.input,
                                'lasttime': that.dateFormat("YYYY-mm-dd", date)
                            })
                        }
                        for (let i = 0; i < jsonData.length; i++) {
                            if (i > 4) {
                                jsonData.splice(i, 1);
                            }
                        }
                        that.historyList = jsonData
                        var str_jsonData = JSON.stringify(jsonData);
                        localStorage.setItem('history', str_jsonData);
                    }
                    else {
                        var jsonData = [{
                            'content': that.input,
                            'lasttime': that.dateFormat("YYYY-mm-dd", date)
                        }];
                        that.historyList = jsonData
                        var str_jsonData = JSON.stringify(jsonData);
                        localStorage.setItem('history', str_jsonData);
                    }

                    that.pager.page = 1
                    that.pager.size = 10
                    that.loadData()
                } else {
                    this.$message({
                        message: '请输入想搜索的内容',
                        type: 'info'
                    })
                }
            },
            loadHotData: function () {
                const that = this
                api.get('/api/FrontEnd/Search/GetHotTagList', {
                    params: {}
                }).then(function (res) {
                    //console.log(res.data)
                    if (res.code == 200) {
                        that.hots = res.data
                    }
                }).catch(function (err) {
                    console.log(err)
                })
            },
            loadArticleData: function () {
                const that = this
                api.get('/api/FrontEnd/Search/GetArticleHotList', {
                    params: {}
                }).then(function (res) {
                    //console.log(res.data)
                    if (res.code == 200) {
                        that.news = res.data
                    }
                }).catch(function (err) {
                    console.log(err)
                })
            },
            doActiveTab: function (val) {   //查询类型
                const that = this
                that.pager.tab = val
                that.pager.page = 1
                that.pager.size = 10
                that.loadData()
            },
            handleSelect(item) {
                console.log(item);
            },
            loadData: function () {
                const that = this
                const loading = this.$loading({
                    lock: true,
                    text: '正在加载中',
                    fullscreen: false,
                    spinner: 'el-icon-loading',
                });
                api.get('/api/FrontEnd/Search/GetPagerList', {
                    params: {
                        keywords: that.input,
                        tab: that.pager.tab,
                        page: that.pager.page,
                        size: that.pager.size,
                    }
                }).then(function (res) {
                    //console.log(res.data)
                    setTimeout(() => {
                        loading.close();
                    }, 500);
                    if (res.code == 200) {
                        that.pager = res.data
                    }

                }).catch(function (err) {
                    console.log(err)
                })
            },
            handleCurrentChange(val) {
                const that = this
                console.log(`当前页: ${val}`);
                that.pager.page = val
                that.loadData()
                setTimeout(that.goPost(), 300)
            },
            goPost() {
                let distance = document.documentElement.scrollTop || document.body.scrollTop; //获得当前高度
                let step = distance / 30; //每步的距离
                (function jump() {
                    if (distance > 0) {
                        distance -= step;
                        window.scrollTo(0, distance);
                        setTimeout(jump, 10);
                    }
                })();
            },
            dateFormat: function (fmt, date) {
                let ret;
                const opt = {
                    "Y+": date.getFullYear().toString(),        // 年
                    "m+": (date.getMonth() + 1).toString(),     // 月
                    "d+": date.getDate().toString(),            // 日
                    "H+": date.getHours().toString(),           // 时
                    "M+": date.getMinutes().toString(),         // 分
                    "S+": date.getSeconds().toString()          // 秒
                    // 有其他格式化字符需求可以继续添加，必须转化成字符串
                };
                for (let k in opt) {
                    ret = new RegExp("(" + k + ")").exec(fmt);
                    if (ret) {
                        fmt = fmt.replace(ret[1], (ret[1].length == 1) ? (opt[k]) : (opt[k].padStart(ret[1].length, "0")))
                    };
                };
                return fmt;
            }
        },
        computed: {
            //historyList: {
            //    get() {
            //        const that = this
            //        // 读取json字符串数据
            //        var getLocalData = localStorage.getItem('history');
            //        console.log('读取json字符串数据',getLocalData)
            //        //console.log(typeof (getLocalData));
            //        //console.log(getLocalData);
            //        var jsonObj = JSON.parse(getLocalData);
            //        console.log(jsonObj)
            //        if (jsonObj != undefined) {
            //            return jsonObj
            //        }
            //        //console.log(typeof (jsonObj));
            //        //console.log(jsonObj);
            //        //console.log(jsonObj[0].content);

            //        //if (that.info.category_list != undefined) {
            //        //    if (that.classNo != '0') {
            //        //        var currArr = that.info.category_list.filter(function (item, index) {
            //        //            return item.pcode === that.classNo
            //        //        })
            //        //        currArr.unshift({ code: '0', name: '全部', pcode: '0' })
            //        //        return currArr
            //        //    }
            //        //}
            //        return []
            //    }
            //},
        }
    })
</script>
